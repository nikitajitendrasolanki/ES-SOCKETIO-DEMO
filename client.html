<!DOCTYPE html>
<html>
<head>
  <title>ElasticSearch + Socket.IO Demo</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <h1>Socket.IO + Elasticsearch Demo Client</h1>

  <h3>Add Product</h3>
  <input id="pname" placeholder="Product name">
  <input id="price" placeholder="Price">
  <input id="category" placeholder="Category">
  <input id="brand" placeholder="Brand">
  <button onclick="addProduct()">Add Product</button>

  <h3>Search Product</h3>
  <input id="search" placeholder="Search text">
  <button onclick="searchProduct()">Search</button>

  <h3>Messages / Products:</h3>
  <ul id="messages"></ul>

  <script>
    const socket = io("http://localhost:3000");

async function addProduct() {
  const name = document.getElementById("pname").value.trim();
  const price = Number(document.getElementById("price").value);
  const category = document.getElementById("category").value.trim();
  const brand = document.getElementById("brand").value.trim();

  if (!name || !price || !category || !brand) {
    return alert("All fields required");
  }

  const res = await fetch("http://localhost:3000/add-product", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, price, category, brand })
  });

  // FIRST: try reading JSON safely
  let data = {};
  try {
    data = await res.json();
  } catch (e) {}

  // HANDLE ERROR
  if (!res.ok) {
    return alert("Error: " + (data.error ?? "Something went wrong"));
  }

  // SUCCESS — do NOT show error
  alert("Product added successfully!");
}

    async function searchProduct() {
      const query = document.getElementById("search").value.trim();
      if (!query) return alert("Enter search text");

      const res = await fetch("http://localhost:3000/search?q=" + encodeURIComponent(query));
      const products = await res.json();

      const ul = document.getElementById("messages");
      ul.innerHTML = "";

      products.forEach(product => {
        const li = document.createElement("li");
        li.textContent = `${product.name} - ₹${product.price} - ${product.category} - ${product.brand}`;
        ul.appendChild(li);
      });
    }

    socket.on("receive-message", (data) => {
      const li = document.createElement("li");
      li.textContent = data.message;
      document.getElementById("messages").appendChild(li);
    });
  </script>
</body>
</html>
